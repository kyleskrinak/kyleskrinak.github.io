# Build & Configuration Guide

## Build Scripts Overview

This project has two distinct build commands, each serving different purposes:

### `npm run build` - Local Development Build
**Purpose**: Full local build with asset optimization
**Includes**: 
- Astro compilation
- Pagefind search index generation
- Copy Pagefind assets to `public/` directory

**Command**:
```bash
npm run build
```

**Output**: Complete site in `dist/` with search assets in `public/_pagefind/`

### `npm run build:ci` - CI/Production Build
**Purpose**: Minimal build for CI pipelines (production deployment)
**Includes**:
- Astro compilation only
- Pagefind search index generation
- ⚠️ **No asset copying** (handled separately in deployment)

**Command**:
```bash
npm run build:ci
```

**Output**: Site in `dist/` with search index in `dist/_pagefind/`

---

## Critical Configuration: Pagefind

### Configuration File: `pagefind.json`

```json
{
  "site": "dist",
  "output_subdir": "_pagefind"
}
```

**Key Setting**: `output_subdir: "_pagefind"` - Uses underscore prefix

### ⚠️ Important: The Underscore

- **Config uses**: `_pagefind` (with underscore)
- **Copy command must use**: `dist/_pagefind` (with underscore)
- **NOT**: `dist/pagefind` (without underscore) ❌

This naming convention is intentional:
- Underscore prefix prevents the directory from being processed by Jekyll/static processors
- Allows Pagefind to serve assets without interference

### Common Error

```
cp: cannot stat 'dist/pagefind': No such file or directory
```

**Cause**: Script references `dist/pagefind` but Pagefind outputs to `dist/_pagefind`

**Fix**: Check that your build scripts match the `pagefind.json` config:
```bash
# CORRECT ✅
cp -r dist/_pagefind public/

# INCORRECT ❌
cp -r dist/pagefind public/
```

---

## Build Script Evolution

### What Changed (Jan 22, 2026)

**Before**:
```json
"build": "astro check && astro build && pagefind --site dist && cp -r dist/pagefind public/"
```

Issues:
1. Redundant `astro check` (already in CI via `build:ci`)
2. **Incorrect path**: `dist/pagefind` didn't match config

**After**:
```json
"build": "astro build && pagefind --site dist && cp -r dist/_pagefind public/"
```

Improvements:
1. ✅ Removed redundant type checking (faster local builds)
2. ✅ Fixed path to match `pagefind.json` config
3. ✅ Consistent with actual Pagefind output

---

## Debugging Build Issues

### Issue: Pagefind not found

**Check 1: Verify pagefind.json config**
```bash
cat pagefind.json
```

Expected output should show `output_subdir: "_pagefind"`

**Check 2: Verify build script paths match**
```bash
cat package.json | grep -A2 '"build"'
```

Look for `dist/_pagefind` in the copy command

**Check 3: Run build and inspect output**
```bash
npm run build
ls -la dist/ | grep pagefind
ls -la public/ | grep pagefind
```

You should see `_pagefind` (with underscore) in both locations

### Issue: Search index missing in production

**Verification**:
```bash
npm run build:ci
ls -la dist/_pagefind/
```

The search index is correctly generated by `build:ci` but NOT copied to `public/`. This is intentional - production deployment handles asset distribution separately via AWS S3.

---

## Deployment Specific

### GitHub Pages (Staging)
- Uses `staging` branch
- Automatically builds with entire `public/` directory
- Search assets included in deployment ✅

### AWS S3 + CloudFront (Production)
- Uses `main` branch  
- Builds with `build:ci` (no copy step)
- S3 sync includes entire `dist/` directory (including `dist/_pagefind/`)
- Search assets served from S3 automatically ✅

---

## References

- [Pagefind Documentation](https://pagefind.app/)
- [Deployment Guide](./deployment.md)
- [astro.config.ts](../../astro.config.ts) - Astro configuration
- [pagefind.json](../../pagefind.json) - Pagefind configuration
