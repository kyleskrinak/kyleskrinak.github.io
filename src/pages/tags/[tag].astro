---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import Main from '@/layouts/Main.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import Card from '@/components/Card.astro';
import { SITE } from '@/config';
import { slugifyStr } from '@/utils/slugify';
import getUniqueTags from '@/utils/getUniqueTags';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const tags = getUniqueTags(posts);

	return tags.map(({ tag, tagName }) => ({
		params: { tag },
		props: { tagName },
	}));
}

interface Props {
	tagName: string;
}

const { tag } = Astro.params;
const { tagName } = Astro.props;

const posts = (await getCollection('blog'))
	.filter((post) => post.data.tags?.some((t) => slugifyStr(t) === tag))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout title={`Tag: ${tagName} | ${SITE.title}`} description={`Posts tagged with: ${tagName}`} noindex={true}>
  <Header />
  <Main pageTitle={["Tag: ", tagName]} titleTransition={tag}>
    <ul>
      {posts.map(post => <Card {...post} variant="h3" />)}
    </ul>
  </Main>
  <Footer />
</Layout>
